<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Mysty's Image Solver</title>
</head>
<body>
<img id="template" hidden src="./template.png">
<select id="classes">
</select>
<p>Requirements:</p>
<ul id="imgL">
</ul>
<p>Half Boosts:</p>
<ul id="halfB">
</ul>
<div>
 <div class="inputoutput">
 <div class="caption">imageSrc <input multiple type="file" id="fileInput" name="file" /></div>
 </div>
</div>
<table id="viewing"></table>
<button type="button" onclick="calculate()">calculate</button>
<script type="text/javascript">
function sumRegion(im1,im2,start,region){
    let R = 0
    let G = 0
    let B = 0
    let total = 0
    if(region == 1){
        // 16-29, 2-15
        // square
        for (let j = 0; j<14;j++){
            for (let i = j; i<27;i++){
                let pixel1 = im1.ucharPtr(start[0]+i+3,start[1]+j+2)
                let pixel2 = im2.ucharPtr(i+3,j+2)
                R+=Math.pow(pixel1[0]/255-pixel2[0]/255,2)
                G+=Math.pow(pixel1[1]/255-pixel2[1]/255,2)
                B+=Math.pow(pixel1[2]/255-pixel2[2]/255,2)
                total+=1
                // im2[i+3,j+2] = np.array([255,0,0])
            }  
        }
    }
    else if(region == 2){
        // i = 0-14
        // j = i-32-i-3
        for (let i = 0; i<14; i++){
            for (let j = i+3;j<32-i-2;j++){
                let pixel1 = im1.ucharPtr(start[0]+i+2,start[1]+j)
                let pixel2 = im2.ucharPtr(i+2,j)
                R+=Math.pow(pixel1[0]/255-pixel2[0]/255,2)
                G+=Math.pow(pixel1[1]/255-pixel2[1]/255,2)
                B+=Math.pow(pixel1[2]/255-pixel2[2]/255,2)
                total+=1
                // im2[i+2,j] = np.array([0,255,0])
            } 
        } 
    }
    else{
        for (let j = 0; j<13;j++){
            for(let i = 16-j; i<30;i++){
                let pixel1 = im1.ucharPtr(start[0]+i,start[1]+j+17)
                let pixel2 = im2.ucharPtr(i,j+17)
                R+=Math.pow(pixel1[0]/255-pixel2[0]/255,2)
                G+=Math.pow(pixel1[1]/255-pixel2[1]/255,2)
                B+=Math.pow(pixel1[2]/255-pixel2[2]/255,2)
                total+=1
                // im2[i,j+17] = np.array([0,0,255])
            } 
        }
    }
    return (R+G+B)/(total*3)
}
function identify(img,loc,img_lib,region){
    let choices = []
    for (let i = 0; i<img_lib.length;i++){
        choices.push(0) 
        choices[i] = sumRegion(img,img_lib[i],loc,region)
    }
    if (Math.min(...choices) < 0.2){
        return choices.indexOf(Math.min(...choices))
    }
    return -1
}
    
function trioFinder(img_rgb, template, reqSkills){
    // setup
    let threshold = 0.3;
    let src = cv.imread(img_rgb);
    let templ = cv.imread(template);
    // containers
    let source = new cv.Mat();
    let dst = new cv.Mat();
    let template1 = new cv.Mat();
    let mask = new cv.Mat();
    cv.cvtColor(src, source, cv.COLOR_RGBA2GRAY, 1);
    cv.cvtColor(templ, template1, cv.COLOR_RGBA2GRAY, 1);
    cv.matchTemplate(source, template1, dst, cv.TM_CCOEFF_NORMED, mask);
    templ.delete();
    template1.delete();
    mask.delete();
    // dst, source and src are the last ones left
    let coords = []
    for(let i = 0; i<dst.rows;i++){
        for(let j = 0; j<dst.cols;j++){
            let pixel = dst.floatPtr(i, j);
            if(pixel[0] >=threshold){
                coords.push([i,j])
            }  
        }
    }
    // clean the coordinates
    skip = []
    clean = []
    for(let i = 0; i<coords.length;i++){
        dont = false
        if(ins(i,skip)){
            continue;
        }
        for(let j = i+1; j<coords.length;j++){
            if ((Math.abs(coords[i][0]-coords[j][0])+Math.abs(coords[i][1]-coords[j][1]))<64){
                let pixel = dst.floatPtr(i, j);
                if(dst.floatPtr(coords[i][0],coords[i][1])[0]>=dst.floatPtr(coords[j][0],coords[j][1])[0]){
                    skip.push(j)
                }
                else if(dst.floatPtr(coords[i][0],coords[i][1])[0]<dst.floatPtr(coords[j][0],coords[j][1])[0]){
                    dont = true
                    break;
                }
            }
        }
        if (!dont){
            clean.push(coords[i])
        } 
    }
    let count = []
    console.log(clean)
    // create nodes
    for(let pt = 0; pt<clean.length;pt++){
        // print(pt1)
        main = identify(src,clean[pt],reqSkills,1)
        up = identify(src,clean[pt],reqSkills,2)
        last = identify(src,clean[pt],reqSkills,3)
        if (main !=-1 && top !=-1 && last !=-1){
            count.push([main.toString(),up.toString(),last.toString()])
        }
    }
    dst.delete()
    source.delete()
    src.delete()
    return count 
}
let viewing = document.getElementById('viewing')
let readimgs = []
let inputElement = document.getElementById('fileInput');
inputElement.addEventListener('change', (e) => {
    readimgs = []
    for(let i = 0; i<e.target.files.length;i++){
        let tempim =  document.createElement("img")
        tempim.src = URL.createObjectURL(e.target.files[i]);
        readimgs.push(tempim)
    }
}, false);
function calculate() {
    nodelib = document.getElementsByClassName("nodeLib")
    viewing.innerHTML = ''
    let img_library =[] 
    let req = []
    let nodes = []
    let half = []
    for(let i = 0;i<nodelib.length;i++){
        img_library.push(cv.imread(nodelib[i]))
    }
    for(let i = 0; i<stateList.length;i++){
        if(stateList[i]){
            req.push(i.toString())
        }
    }
    for(let i = 0; i<halfState.length;i++){
        if(halfState[i]){
            half.push(i.toString())
        }
    }
    for(let i = 0; i<readimgs.length;i++){
        nodes = [...nodes,...trioFinder(readimgs[i],'template',img_library)]
    }
    console.log(nodes)
    trios = main1(nodes,req,half)
    let fileList = file[clas]
    if(trios =="impossible"){
        viewing.appendChild(document.createTextNode(trios))
    }
    else if (trios == "bad input (unlock nodes or open more nodes)"){
        viewing.appendChild(document.createTextNode(trios))
    }
    else{
        for(let i = 0; i<trios.length;i++){
            row1 = document.createElement('tr')
            for(let j = 0; j<3;j++){
                let image = document.createElement('img')
                image.src = directory+clas+"/"+fileList[parseInt(trios[i][j])]
                data = document.createElement('td')
                data.appendChild(image)
                row1.appendChild(data)
            }
            viewing.appendChild(row1)
        }
    }
    
};
</script>
<script async src="opencv.js" type="text/javascript"></script>
<script src="imageSolver.js" type="text/javascript"></script>
</body>
</html>